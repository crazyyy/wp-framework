function wpo_parse_json(s){try{var e=JSON.parse(s);return e}catch(o){console.log("WPO: Exception when trying to parse JSON (1) - will attempt to fix/re-parse"),console.log(s)}var i=s.indexOf("{"),a=s.lastIndexOf("}");if(i>-1&&a>-1){var t=s.slice(i,a+1);try{var n=JSON.parse(t);return console.log("WPO: JSON re-parse successful"),n}catch(o){console.log("WPO: Exception when trying to parse JSON (2) - will attempt to fix/re-parse based upon bracket counting");for(var m=i,r=0,_="",u=!1;(r>0||m==i)&&m<=a;){var c=s.charAt(m);u||"{"!=c?u||"}"!=c?'"'==c&&"\\"!=_&&(u=!u):r--:r++,_=c,m++}console.log("Started at cursor="+i+", ended at cursor="+m+" with result following:"),console.log(s.substring(i,m));try{var n=JSON.parse(s.substring(i,m));return console.log("WPO: JSON re-parse successful"),n}catch(o){throw o}}}throw"WPO: could not parse the JSON"}jQuery(document).ready(function(s){WP_Optimize_Smush=WP_Optimize_Smush()});var WP_Optimize_Smush=function(){function s(s){var s="undefined"==typeof s||s,e={use_cache:s};console.log("Loading information about uncompressed images."),O.html("..."),I.hide(),d(!0),k("get_ui_update",e,function(s){console.log("Information about uncompressed images loaded."),b(s,m),h(),d(!1)})}function e(){y("#wpo_smush_images_grid input:checked").each(function(){image={attachment_id:y(this).val(),blog_id:y(this).data("blog")},Q.push(image)}),data={optimization_id:"smush",selected_images:Q,smush_options:{compression_server:y("input[name='compression_server']:checked").val(),image_quality:y("#image_quality").val(),lossy_compression:y("#smush-lossy-compression").is(":checked"),back_up_original:y("#smush-backup-original").is(":checked"),preserve_exif:y("#smush-preserve-exif").is(":checked")}},r(),k("process_bulk_smush",data)}function o(){if(y("#wp-optimize-wrap").length){y("#wpo_smush_images_save_options_spinner").show().delay(3e3).fadeOut(),y("#enable_custom_compression").is(":checked")?(image_quality=y("#custom_compression_slider").val(),lossy_compression=image_quality<100):(image_quality=y("#enable_lossy_compression").is(":checked")?90:100,lossy_compression=image_quality<100);var s={compression_server:y("input[name='compression_server']:checked").val(),image_quality:image_quality,lossy_compression:lossy_compression,back_up_original:y("#smush-backup-original").is(":checked"),preserve_exif:y("#smush-preserve-exif").is(":checked"),autosmush:y("#smush-automatically").is(":checked"),show_smush_metabox:y("#smush-show-metabox").is(":checked")};k("update_smush_options",s,function(s){y("#wpo_smush_images_save_options_spinner").hide(),s.hasOwnProperty("saved")&&s.saved?(y("#wpo_smush_images_save_options_done").show().delay(3e3).fadeOut(),q.hide()):(y("#wpo_smush_images_save_options_fail").show().delay(3e3).fadeOut(),q.show())})}}function a(){A=!0,T++,seconds=T%60+""<10?"0"+T%60:T%60,minutes=parseInt(T/60)+""<10?"0"+parseInt(T/60):parseInt(T/60),y("#smush_stats_timer").text(minutes+":"+seconds),t(T)}function t(s){0==s%3&&n(),0==s%60&&k("process_pending_images",{},function(s){b(s,_)})}function n(s){data={update_ui:!0,use_cache:!1},k("get_ui_update",data,function(s){b(s,_)})}function m(s){if(x.html(""),s&&s.hasOwnProperty("unsmushed_images")){s.unsmushed_images,s.pending_tasks;0==s.unsmushed_images.length&&0==s.pending_tasks&&x.text(wposmush.all_images_compressed).wrapInner("<div class='wpo-fieldgroup'> </div>"),0!=s.pending_tasks&&I.show().find(".red").text(s.pending);var e="post.php?post=",o="&action=edit";for(blog_id in s.unsmushed_images)for(i in s.unsmushed_images[blog_id])s.unsmushed_images[blog_id].hasOwnProperty(i)&&(image=s.unsmushed_images[blog_id][i],p(image,blog_id,s.admin_urls[blog_id]+e+image.id+o))}}function r(){A||(v(y("#wpo_smush_images_information_container")),service=y('.compression_server input[type="radio"]:checked + label small').text(),y("#wpo_smush_images_information_server").html(service),y("#smush_stats_pending_images").html("..."),y("#smush_stats_completed_images").html("..."),y("#smush_stats_bytes_saved").html("..."),y("#smush_stats_percent_saved").html("..."),y("#smush_stats_timer").html("..."),E=window.setInterval(a,1e3),d(!0))}function _(s){y("#smush_stats_pending_images").html(s.pending_tasks),y("#smush_stats_completed_images").html(s.completed_task_count),y("#smush_stats_bytes_saved").html(s.bytes_saved),y("#smush_stats_percent_saved").html(s.percent_saved),1==s.smush_complete&&setTimeout(u,1500)}function u(){data={update_ui:!0,use_cache:!1,image_list:Q},k("get_ui_update",data,function(s){summary=s.session_stats,0!=s.completed_task_count&&(summary+="<hr>"+s.summary),c(summary)})}function c(s){D||(y("#summary-message").html(s),l(),v(y("#smush-complete-summary")),D=!0)}function l(){T=0,A=!1,D=!1,Q=[],window.clearInterval(E),d(!1)}function p(s,e,o){var i=["wpo_smush_",e,"_",s.id].join("");image_html='<div class="wpo_smush_image" data-filesize="'+s.filesize+'">',image_html+='<a class="button" href="'+o+'" target="_blank"> '+wposmush.view_image+" </a>",image_html+='<input id="'+i+'" type="checkbox" data-blog="'+e+'" class="wpo_smush_image__input" value="'+s.id+'">',image_html+='<label for="'+i+'"></a>',image_html+='<div class="thumbnail">',image_html+='<img class="lazyload" src="'+s.thumb_url+'">',image_html+="</div></label></div>",x.append(image_html)}function h(){features=wposmush.features,service=y("input[name^='compression_server']:checked").val();for(feature in features[service])y("."+feature).prop("disabled",!features[service][feature]),y("."+feature).prop("checked",features[service][feature]);y(".wpo_smush_image").each(function(){y(this).data("filesize")>wposmush.features[service].max_filesize?y(this).hide():y(this).show()})}function d(s){y.each([N,U,j,q,S,z],function(e,o){o.prop("disabled",s)}),s?(y("#wpo_smush_images_refresh").hide(),y(".wpo_smush_images_loader").show()):(y("#wpo_smush_images_refresh").show(),y(".wpo_smush_images_loader").hide())}function g(s,e){0!=s.length&&(data={selected_image:s,smush_options:e},v(wposmush.compress_single_image_dialog),k("compress_single_image",data,function(s){b(s,w)}))}function f(s){0!=s.length&&(v(wposmush.please_wait,y.unblockUI),data={selected_image:s},k("restore_single_image",data,function(s){b(s,w)}))}function w(s){s.hasOwnProperty("success")&&s.success?(y("#smush-information").text(s.summary),v(y("#smush-information-modal"),y.unblockUI),y(".toggle-smush-advanced.wpo_smush_single_image").removeClass("opened"),"compress"==s.operation?(y(".wpo_smush_single_image").hide(),y(".wpo_restore_single_image").show(),y("#smush_info").text(s.summary),s.restore_possible?y(".restore_possible").show():y(".restore_possible").hide()):(y(".wpo_smush_single_image").show(),y(".wpo_restore_single_image").hide())):(y("#smush-information").text(s.error_message),v(y("#smush-information-modal"),y.unblockUI))}function v(s,e){y.blockUI({message:s,onOverlayClick:e,baseZ:160001,css:{width:"400px",padding:"20px",cursor:"pointer"}})}function b(s,e){s&&s.hasOwnProperty("status")&&s.status?e&&e(s):(alert(wposmush.error_unexpected_response),console.log(s))}function k(s,e,o,i){i="undefined"==typeof i||i,e=y.isEmptyObject(e)?{use_cache:!1}:e;var a={action:"updraft_smush_ajax",subaction:s,nonce:wposmush.smush_ajax_nonce,data:e},t={type:"POST",url:ajaxurl,data:a,success:function(s){if(i){try{var e=wpo_parse_json(s)}catch(a){console.log("smush_manager_send_command JSON parse error"),console.log(a),console.log(s),alert(wposmush.error_unexpected_response)}"undefined"!=typeof o&&o(e)}else"undefined"!=typeof o&&o(s)},error:function(s,e,i){console.log("smush_manager_send_command AJAX parse error: "+e+" ("+i+")"),"undefined"!=typeof o?o(s):(console.log(s),alert(wposmush.error_unexpected_response))},dataType:"text"};y.ajax(t)}var y=jQuery,x=(y("#wp-optimize-images-nav-tab-smush"),y("#wpo_smush_images_grid")),O=y("#smush_info_images"),I=y("#wpo_smush_images_pending_tasks_container"),z=y("#wpo_smush_images_pending_tasks_button"),P=y("#wpo_smush_images_pending_tasks_cancel_button"),q=y(".wpo-fieldgroup #wpo_smush_images_save_options_button"),S=y("#wpo_smush_images_refresh"),U=y("#wpo_smush_images_select_all"),j=y("#wpo_smush_images_select_none"),J=y("#wpo_smush_clear_stats_btn"),N=y("#wpo_smush_images_btn"),W=(y(".wpo_smush_single_image .button"),y(".wpo_restore_single_image .button"),y(".wpo_smush_get_logs")),C=y(".compression_server"),T=0,A=!1,E=0,Q=[],D=!1;y("#wp-optimize-nav-tab-wrapper__wpo_images .nav-tab").on("click",function(){y(this).is("#wp-optimize-nav-tab-wpo_images-smush")&&s()}),y("#wp-optimize-wrap").on("page-change",function(e,o){"wpo_images"==o.page&&y("#wp-optimize-nav-tab-wrapper__wpo_images .nav-tab-active").is("#wp-optimize-nav-tab-wpo_images-smush")&&s()}),y("#smush-metabox").length>0&&h(),C.on("change",function(s){h(),o()}),N.off().on("click",function(){return 0==y('#wpo_smush_images_grid input[type="checkbox"]:checked').length?(y("#smush-information-modal #smush-information").text(wposmush.please_select_images),void v(y("#smush-information-modal"),y.unblockUI)):(y("#smush-information-modal #smush-information").text(wposmush.server_check),v(y("#smush-information-modal")),data={server:y("input[name='compression_server']:checked").val()},void k("check_server_status",data,function(s){s.online?e():(s.error?(error_message=s.error+"<br>"+wposmush.server_error,y("#smush-information-modal #smush-information").html(error_message)):y("#smush-information-modal #smush-information").text(wposmush.server_error),v(y("#smush-information-modal"),y.unblockUI))}))}),S.off().on("click",function(){s()}),U.off().on("click",function(){y('#wpo_smush_images_grid input[type="checkbox"]').prop("checked",!0)}),j.off().on("click",function(){y('#wpo_smush_images_grid input[type="checkbox"]').prop("checked",!1)}),W.off().on("click",function(){y("#log-panel").text("Please wait, fetching logs."),k("get_smush_logs",{},function(s){y.blockUI({message:y("#smush-log-modal"),onOverlayClick:y.unblockUI(),css:{width:"80%",height:"80%",top:"15%",left:"15%"}}),y("#log-panel").html("<pre>"+s+"</pre>"),download_link=ajaxurl+"?action=updraft_smush_ajax&subaction=get_smush_logs&nonce="+wposmush.smush_ajax_nonce,y("#smush-log-modal a").attr("href",download_link),console.log(download_link)},!1)}),q.off().on("click",function(s){o()}),J.off().on("click",function(s){y("#wpo_smush_images_clear_stats_spinner").show().delay(3e3).fadeOut(),k("clear_smush_stats",{},function(s){y("#wpo_smush_images_clear_stats_spinner").hide(),y("#wpo_smush_images_clear_stats_done").show().delay(3e3).fadeOut()})}),z.off().on("click",function(s){y("#smush-information-modal #smush-information").text(wposmush.server_check),v(y("#smush-information-modal"),y.unblockUI),data={server:y("input[name='compression_server']:checked").val()},k("check_server_status",data,function(s){s.online?(r(),k("process_pending_images",{},function(s){b(s,_)})):(s.error?(error_message=s.error+"<br>"+wposmush.server_error,y("#smush-information-modal #smush-information").html(error_message)):y("#smush-information-modal #smush-information").text(wposmush.server_error),v(y("#smush-information-modal"),y.unblockUI))})}),P.on("click",function(s){k("clear_pending_images",{},function(s){s.status&&I.delay(3e3).fadeOut()})}),y("body").on("click",".wpo_smush_single_image .button",function(){image={attachment_id:y(this).attr("id").substring(15),blog_id:y(this).data("blog")},y("#enable_custom_compression").is(":checked")?(image_quality=y("#custom_compression_slider").val(),lossy_compression=image_quality<100):(image_quality=y("#enable_lossy_compression").is(":checked")?90:100,lossy_compression=image_quality<100),smush_options={compression_server:y("input[name='compression_server_"+image.attachment_id+"']:checked").val(),image_quality:image_quality,lossy_compression:lossy_compression,back_up_original:y("#smush_backup_"+image.attachment_id).is(":checked"),preserve_exif:y("#smush_exif_"+image.attachment_id).is(":checked")},console.log("Compressing Image : "+image.attachment_id),data={server:y("input[name='compression_server_"+y(this).attr("id").substring(15)+"']:checked").val()},v(wposmush.server_check),k("check_server_status",data,function(s){s.online?g(image,smush_options):s.error?(error_message=s.error+"<br>"+wposmush.server_error,v(error_message,y.unblockUI)):v(wposmush.server_error,y.unblockUI)})}),y("body").on("click",".wpo_restore_single_image .button",function(){var s=y(this).attr("id");s&&(image_id=s.substring(25),console.log("Restoring Image : "+image_id),f(image_id))}),y("body").on("click","#smush-log-modal .close, #smush-information-modal .information-modal-close",function(){y.unblockUI()}),y("body").on("click",".wpo_smush_stats_cta_btn, .wpo_smush_get_logs, #smush-complete-summary .close",function(){y.unblockUI(),s(),setTimeout(l,500)}),y("body").on("click",".toggle-smush-advanced",function(s){s.preventDefault(),y(this).toggleClass("opened")}),y(".wpo-fieldgroup .autosmush input, .wpo-fieldgroup .compression_level, .wpo-fieldgroup .image_options, #smush-show-metabox").on("change",function(s){o()}),y("body").on("change",".smush-options.compression_level",function(){y("#enable_custom_compression").is(":checked")?y(".smush-options.custom_compression").show():y(".smush-options.custom_compression").hide()}),y("body").on("change",'.smush-advanced input[type="radio"]',function(){h()})};