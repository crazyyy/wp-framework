function wpo_parse_json(s){if("object"==typeof s)return s;try{var e=JSON.parse(s);return e}catch(o){console.log("WPO: Exception when trying to parse JSON (1) - will attempt to fix/re-parse"),console.log(s)}var i=s.indexOf("{"),t=s.lastIndexOf("}");if(i>-1&&t>-1){var a=s.slice(i,t+1);try{var n=JSON.parse(a);return n}catch(o){console.log("WPO: Exception when trying to parse JSON (2) - will attempt to fix/re-parse based upon bracket counting");for(var m=i,_=0,r="",u=!1;(_>0||m==i)&&m<=t;){var c=s.charAt(m);u||"{"!=c?u||"}"!=c?'"'==c&&"\\"!=r&&(u=!u):_--:_++,r=c,m++}console.log("Started at cursor="+i+", ended at cursor="+m+" with result following:"),console.log(s.substring(i,m));try{var n=JSON.parse(s.substring(i,m));return n}catch(o){throw o}}}throw"WPO: could not parse the JSON"}jQuery(function(s){WP_Optimize_Smush=WP_Optimize_Smush()});var WP_Optimize_Smush=function(){function s(){var s=0==P('input[type="checkbox"]:checked',j).length;M.prop("disabled",s),A.prop("disabled",s)}function e(s,o){if(smush_mark_all_as_uncompressed){var i=P("#smush-information-modal-cancel-btn .smush-information");z("mark_all_as_uncompressed",{restore_backup:s?1:0,delete_only_backups_meta:o?1:0},function(o){if(smush_mark_all_as_uncompressed)return o.hasOwnProperty("error")?(I(P("#smush-information-modal"),P.unblockUI),P("#smush-information-modal .smush-information").text(o.error),void t()):void(o.completed?(I(P("#smush-information-modal"),P.unblockUI),P("#smush-information-modal .smush-information").text(o.message),t()):(i.text(o.message),e(s)))})}}function o(){P(this).toggleClass("opened"),P(this).hasClass("opened")?P(this).text(wposmush.less):P(this).text(wposmush.more)}function t(e){var e="undefined"==typeof e||e,o={use_cache:e};S.html("..."),q.hide(),k(!0),z("get_ui_update",o,function(e){U(e,u),b(),k(!1),s()})}function a(){P("#wpo_smush_images_grid input:checked").each(function(){image={attachment_id:P(this).val(),blog_id:P(this).data("blog")},smush_image_list.push(image)}),data={optimization_id:"smush",selected_images:smush_image_list,smush_options:{compression_server:P("input[name='compression_server']:checked").val(),image_quality:P("#image_quality").val(),lossy_compression:P("#smush-lossy-compression").is(":checked"),back_up_original:P("#smush-backup-original").is(":checked"),preserve_exif:P("#smush-preserve-exif").is(":checked")}},p(),z("process_bulk_smush",data)}function n(){if(P("#wp-optimize-wrap").length){P("#wpo_smush_images_save_options_spinner").show().delay(3e3).fadeOut();var s=F();z("update_smush_options",s,function(s){P("#wpo_smush_images_save_options_spinner").hide(),s.hasOwnProperty("saved")&&s.saved?(P("#wpo_smush_images_save_options_done").show().delay(3e3).fadeOut(),J.hide()):(P("#wpo_smush_images_save_options_fail").show().delay(3e3).fadeOut(),J.show())})}}function m(){smush_timer_locked=!0,smush_total_seconds++,seconds=smush_total_seconds%60+""<10?"0"+smush_total_seconds%60:smush_total_seconds%60,minutes=parseInt(smush_total_seconds/60)+""<10?"0"+parseInt(smush_total_seconds/60):parseInt(smush_total_seconds/60),P("#smush_stats_timer").text(minutes+":"+seconds),_(smush_total_seconds)}function _(s){0==s%3&&r(),0==s%60&&z("process_pending_images",{},function(s){U(s,h)})}function r(s){data={update_ui:!0,use_cache:!1},z("get_ui_update",data,function(s){U(s,h)})}function u(s){if(j.html(""),s&&s.hasOwnProperty("unsmushed_images")){var e=s.unsmushed_images,o=s.pending_tasks,i=0;if(0==e.length&&0==o&&j.text(wposmush.all_images_compressed).wrapInner("<div class='wpo-fieldgroup'> </div>"),0!=o&&q.show().find(".red").text(s.pending),1===s.is_multisite)i=uncompressed_images_sites_select.find(":selected").val(),l(i,s);else for(i in s.unsmushed_images)l(i,s)}}function c(s,e){return s.id-e.id}function l(s,e){var o="post.php?post=",t="&action=edit",a=e.admin_urls[s],n=e.unsmushed_images[s];"undefined"!=typeof n&&n.sort(c);for(i in n)if(n.hasOwnProperty(i)){var m=n[i];w(m,s,a+o+m.id+t)}}function p(){smush_timer_locked||(I(P("#wpo_smush_images_information_container")),service=P('.compression_server input[type="radio"]:checked + label small').text(),P("#wpo_smush_images_information_server").html(service),P("#smush_stats_pending_images").html("..."),P("#smush_stats_completed_images").html("..."),P("#smush_stats_bytes_saved").html("..."),P("#smush_stats_percent_saved").html("..."),P("#smush_stats_timer").html("..."),smush_timer_handle=window.setInterval(m,1e3),k(!0))}function h(s){P("#smush_stats_pending_images").html(s.pending_tasks),P("#smush_stats_completed_images").html(s.completed_task_count),P("#smush_stats_bytes_saved").html(s.bytes_saved),P("#smush_stats_percent_saved").html(s.percent_saved),1==s.smush_complete&&setTimeout(d,1500)}function d(){data={update_ui:!0,use_cache:!1,image_list:smush_image_list},z("get_ui_update",data,function(s){summary=s.session_stats,0!=s.completed_task_count&&(summary+="<hr>"+s.summary),g(summary)})}function g(s){smush_completed||(P("#summary-message").html(s),f(),I(P("#smush-complete-summary")),smush_completed=!0)}function f(){smush_total_seconds=0,smush_timer_locked=!1,smush_completed=!1,smush_image_list=[],window.clearInterval(smush_timer_handle),k(!1)}function w(s,e,o){var i=["wpo_smush_",e,"_",s.id].join("");image_html='<div class="wpo_smush_image" data-filesize="'+s.filesize+'">',image_html+='<a class="button" href="'+o+'" target="_blank"> '+wposmush.view_image+" </a>",image_html+='<input id="'+i+'" type="checkbox" data-blog="'+e+'" class="wpo_smush_image__input" value="'+s.id+'">',image_html+='<label for="'+i+'"></a>',image_html+='<div class="thumbnail">',image_html+='<img class="lazyload" src="'+s.thumb_url+'">',image_html+="</div></label></div>",j.append(image_html)}function b(){features=wposmush.features,service=P("input[name^='compression_server']:checked").val();for(feature in features[service])P("."+feature).prop("disabled",!features[service][feature]);P(".wpo_smush_image").each(function(){P(this).data("filesize")>wposmush.features[service].max_filesize?P(this).hide():P(this).show()})}function k(s){P.each([M,W,T,J,N,C,A],function(e,o){o.prop("disabled",s)}),s?(P("#wpo_smush_images_refresh").hide(),P(".wpo_smush_images_loader").show()):(P("#wpo_smush_images_refresh").show(),P(".wpo_smush_images_loader").hide())}function v(s,e){0!=s.length&&(data={selected_image:s,smush_options:e},I(wposmush.compress_single_image_dialog),z("compress_single_image",data,function(s){U(s,x)}))}function y(s,e){if(0!=e.length){I(wposmush.please_wait,P.unblockUI);var o={blog_id:s,selected_image:e};z("restore_single_image",o,function(s){U(s,x)})}}function x(s){if(s.hasOwnProperty("success")&&s.success){P(".smush-information").text(s.summary),I(P("#smush-information-modal"),P.unblockUI),P(".wpo-toggle-advanced-options.wpo_smush_single_image").removeClass("opened"),O(s.operation,s.summary,s.restore_possible,s);var e=s.blog_id||s.options.blog_id,o=s.image||s.options.attachment_id;smush_affected_images.hasOwnProperty(e)||(smush_affected_images[e]={}),smush_affected_images[e].hasOwnProperty(o)||(smush_affected_images[e][o]={}),"compress"==s.operation?smush_affected_images[e][o]={operation:s.operation,summary:s.summary,restore_possible:s.restore_possible}:smush_affected_images[e][o]={operation:s.operation}}else P(".smush-information").text(s.error_message),I(P("#smush-information-modal"),P.unblockUI)}function O(s,e,o,i){var t=P("#smush_info").closest("#smush-metabox-inside-wrapper");"compress"==s?(P(".wpo_smush_single_image").hide(),P(".wpo_restore_single_image").show(),i&&i.hasOwnProperty("sizes-info")?(P("#smush_info").text(e),P("#wpo_smush_details").html(i["sizes-info"])):(P("#smush_info").text(e),P("#wpo_smush_details").text("").hide()),P(".wpo_smush_mark_single_image").hide(),o?P(".restore_possible").show():P(".restore_possible").hide()):(P(".wpo_smush_single_image").show(),P(".wpo_restore_single_image").hide(),P(".wpo_smush_mark_single_image").show(),P(".wpo_smush_unmark_single_image",t).hide())}function I(s,e){P.blockUI({message:s,onOverlayClick:e,baseZ:160001,css:{width:"400px",padding:"20px",cursor:"pointer"}})}function U(s,e){s&&s.hasOwnProperty("status")&&s.status?e&&e(s):(alert(wposmush.error_unexpected_response),console.log(s))}function z(s,e,o,i){i="undefined"==typeof i||i,e=P.isEmptyObject(e)?{use_cache:!1}:e;var t={action:"updraft_smush_ajax",subaction:s,nonce:wposmush.smush_ajax_nonce,data:e},a={type:"POST",url:ajaxurl,data:t,success:function(s){if(i){try{var e=wpo_parse_json(s)}catch(t){console.log("smush_manager_send_command JSON parse error"),console.log(t),console.log(s),alert(wposmush.error_unexpected_response)}"undefined"!=typeof o&&o(e)}else"undefined"!=typeof o&&o(s)},error:function(s,e,i){console.log("smush_manager_send_command AJAX parse error: "+e+" ("+i+")"),"undefined"!=typeof o?o(s):(console.log(s),alert(wposmush.error_unexpected_response))},dataType:"text"};P.ajax(a)}var P=jQuery,j=(P("#wp-optimize-images-nav-tab-smush"),P("#wpo_smush_images_grid")),S=P("#smush_info_images"),q=P("#wpo_smush_images_pending_tasks_container"),C=P("#wpo_smush_images_pending_tasks_button"),J=P(".wpo-fieldgroup #wpo_smush_images_save_options_button"),N=P("#wpo_smush_images_refresh"),W=P("#wpo_smush_images_select_all"),T=P("#wpo_smush_images_select_none"),K=P("#wpo_smush_clear_stats_btn"),M=P("#wpo_smush_images_btn"),A=P("#wpo_smush_mark_as_compressed"),D=(P(".wpo_smush_single_image .button"),P(".wpo_restore_single_image .button"),P(".wpo_smush.column-wpo_smush .convert-to-webp"));smush_mark_all_as_uncompressed_btn=P("#wpo_smush_mark_all_as_uncompressed_btn"),restore_all_compressed_images_btn=P("#wpo_smush_restore_all_compressed_images_btn"),smush_view_logs_btn=P(".wpo_smush_get_logs"),smush_delete_backup_images_btn=P("#wpo_smush_delete_backup_btn"),compression_server_select=P(".compression_server"),reset_webp_serving_method_btn=P("#wpo_reset_webp_serving_method"),smush_images_tab_loaded=!1,smush_service_features=[],smush_total_seconds=0,smush_timer_locked=!1,smush_timer_handle=0,smush_image_list=[],smush_completed=!1,smush_mark_all_as_uncompressed=!1,smush_affected_images={},pending_tasks_cancel_btn=P("#wpo_smush_images_pending_tasks_cancel_button"),uncompressed_images_sites_select=P("#wpo_uncompressed_images_sites_select"),j.on("click",".thumbnail",function(s){P(this).closest('input[type="checkbox"]').prop("checked",!0)});var E=!1;j.on("mousedown",".thumbnail",function(s){E=s.shiftKey||s.ctrlKey}),j.on("mouseup",".thumbnail",function(s){E=s.shiftKey||s.ctrlKey}),reset_webp_serving_method_btn.on("click",function(s){s.preventDefault(),z("reset_webp_serving_method",{},function(s){s.success?P("#wpo_reset_webp_serving_method_done").show().delay(3e3).fadeOut():console.log("[Failed] WebP server capability detection")})}),P("#wp-optimize-nav-tab-wrapper__wpo_images .nav-tab").on("click",function(){P(this).is("#wp-optimize-nav-tab-wpo_images-smush")&&t()}),P("#wp-optimize-wrap").on("page-change",function(s,e){"wpo_images"==e.page&&P("#wp-optimize-nav-tab-wrapper__wpo_images .nav-tab-active").is("#wp-optimize-nav-tab-wpo_images-smush")&&t()}),P("#smush-metabox").length>0&&b();var Q=null;j.on("click",".wpo_smush_image",function(e){var o=P('#wpo_smush_images_grid input[type="checkbox"]'),i=P(this).find(".wpo_smush_image__input"),t=!i.prop("checked");if(Q||(P(this).find(".wpo_smush_image__input").prop("checked",t),Q=i),!0===E){var a=o.index(i),n=o.index(Q);a===n?o.slice(Math.min(a,n),Math.max(a,n)+1).prop("checked",t):!0===Q.prop("checked")&&o.slice(Math.min(a,n),Math.max(a,n)+1).prop("checked",t)}Q=i,s()}),s(),compression_server_select.on("change",function(s){b(),n()}),M.off().on("click",function(){return 0==P('#wpo_smush_images_grid input[type="checkbox"]:checked').length?(P("#smush-information-modal .smush-information").text(wposmush.please_select_images),void I(P("#smush-information-modal"),P.unblockUI)):(P("#smush-information-modal .smush-information").text(wposmush.server_check),I(P("#smush-information-modal")),data={server:P("input[name='compression_server']:checked").val()},void z("check_server_status",data,function(s){s.online?a():(s.error?(error_message=s.error+"<br>"+wposmush.server_error,P("#smush-information-modal .smush-information").html(error_message)):P("#smush-information-modal .smush-information").text(wposmush.server_error),I(P("#smush-information-modal"),P.unblockUI))}))}),A.off().on("click",function(){if(0==P('#wpo_smush_images_grid input[type="checkbox"]:checked').length)return P("#smush-information-modal .smush-information").text(wposmush.please_select_compressed_images),void I(P("#smush-information-modal"),P.unblockUI);var s,e=[];P("#wpo_smush_images_grid input:checked").each(function(){s={attachment_id:P(this).val(),blog_id:P(this).data("blog")},e.push(s)}),I(wposmush.please_updating_images_info),z("mark_as_compressed",{selected_images:e},function(s){P("#smush-information-modal .smush-information").text(s.summary),I(P("#smush-information-modal"),P.unblockUI),t()})}),smush_mark_all_as_uncompressed_btn.on("click",function(){if(confirm(wposmush.mark_all_images_uncompressed)){var s=confirm(wposmush.restore_images_from_backup);I(P("#smush-information-modal-cancel-btn")),P("#smush-information-modal-cancel-btn .smush-information").text(wposmush.please_wait),smush_mark_all_as_uncompressed=!0,e(s)}}),restore_all_compressed_images_btn.on("click",function(){confirm(wposmush.restore_all_compressed_images)&&(I(P("#smush-information-modal-cancel-btn")),P("#smush-information-modal-cancel-btn .smush-information").text(wposmush.please_wait),smush_mark_all_as_uncompressed=!0,e(!0,!0))}),P('#smush-information-modal-cancel-btn input[type="button"]').on("click",function(){smush_mark_all_as_uncompressed=!1,t(),P.unblockUI()}),N.off().on("click",function(){t()}),W.off().on("click",function(){P('#wpo_smush_images_grid input[type="checkbox"]').prop("checked",!0),Q=null,s()}),T.off().on("click",function(){P('#wpo_smush_images_grid input[type="checkbox"]').prop("checked",!1),Q=null,s()}),smush_view_logs_btn.off().on("click",function(){P("#log-panel").text("Please wait, fetching logs."),z("get_smush_logs",{},function(s){P.blockUI({message:P("#smush-log-modal"),onOverlayClick:P.unblockUI(),css:{width:"80%",height:"80%",top:"15%",left:"15%"}}),P("#log-panel").html("<pre>"+s+"</pre>"),download_link=ajaxurl+"?action=updraft_smush_ajax&subaction=get_smush_logs&nonce="+wposmush.smush_ajax_nonce,P("#smush-log-modal a").attr("href",download_link)},!1)}),smush_delete_backup_images_btn.on("click",function(){if(confirm(wposmush.delete_image_backup_confirm)){smush_delete_backup_images_btn.prop("disabled",!0);var s=P("#wpo_smush_delete_backup_spinner"),e=P("#wpo_smush_delete_backup_done");s.show(),z("clean_all_backup_images",{},function(){s.hide(),smush_delete_backup_images_btn.prop("disabled",!1),e.css("display","inline-block").delay(3e3).fadeOut()})}}),J.off().on("click",function(s){n()}),K.off().on("click",function(s){P("#wpo_smush_images_clear_stats_spinner").show().delay(3e3).fadeOut(),z("clear_smush_stats",{},function(s){P("#wpo_smush_images_clear_stats_spinner").hide(),P("#wpo_smush_images_clear_stats_done").show().delay(3e3).fadeOut()})}),C.off().on("click",function(s){P("#smush-information-modal .smush-information").text(wposmush.server_check),I(P("#smush-information-modal"),P.unblockUI),data={server:P("input[name='compression_server']:checked").val()},z("check_server_status",data,function(s){s.online?(p(),z("process_pending_images",{},function(s){U(s,h)})):(s.error?(error_message=s.error+"<br>"+wposmush.server_error,P("#smush-information-modal .smush-information").html(error_message)):P("#smush-information-modal .smush-information").text(wposmush.server_error),I(P("#smush-information-modal"),P.unblockUI))})}),P("body").on("click","#wpo_smush_images_pending_tasks_cancel_button",function(s){wpoptimize.cancel===pending_tasks_cancel_btn.val()&&(pending_tasks_cancel_btn.val(wpoptimize.cancelling),pending_tasks_cancel_btn.prop("disabled",!0)),z("clear_pending_images",{},function(s){P.unblockUI(),s.status?(t(),f()):console.log("Cancelling pending images apparently failed.",s),pending_tasks_cancel_btn.val(wpoptimize.cancel),pending_tasks_cancel_btn.prop("disabled",!1)})}),P("body").on("click",".wpo_smush_single_image .button",function(){image={attachment_id:P(this).data("id"),blog_id:P(this).data("blog")},P("#enable_custom_compression").is(":checked")?image_quality=P("#custom_compression_slider").val():image_quality=P("#enable_lossy_compression").is(":checked")?60:100,lossy_compression=image_quality<100,smush_options={compression_server:P("input[name='compression_server_"+image.attachment_id+"']:checked").val(),image_quality:image_quality,lossy_compression:lossy_compression,back_up_original:P("#smush_backup_"+image.attachment_id).is(":checked"),preserve_exif:P("#smush_exif_"+image.attachment_id).is(":checked")},data={server:P("input[name='compression_server_"+P(this).attr("id").substring(15)+"']:checked").val()},I(wposmush.server_check),z("check_server_status",data,function(s){s.online?v(image,smush_options):s.error?(error_message=s.error+"<br>"+wposmush.server_error,I(error_message,P.unblockUI)):I(wposmush.server_error,P.unblockUI)})}),P("body").on("click",".wpo_restore_single_image .button",function(){var s=P(this);blog_id=s.data("blog"),image_id=s.data("id"),image_id&&blog_id&&y(blog_id,image_id)}),P("body").on("click",".wpo_smush_mark_single_image .button",function(){var s={attachment_id:P(this).data("id"),blog_id:P(this).data("blog")},e=P(this).closest("#smush-metabox-inside-wrapper");I(wposmush.please_updating_images_info),z("mark_as_compressed",{selected_images:[s]},function(s){P("#smush-information-modal .smush-information").text(s.summary),I(P("#smush-information-modal"),P.unblockUI),s.status&&(P(".wpo_smush_single_image",e).hide(),P(".wpo-toggle-advanced-options",e).removeClass("opened"),P(".wpo_smush_mark_single_image",e).hide(),P(".wpo_smush_unmark_single_image",e).show(),P(".wpo_restore_single_image",e).show(),P("#smush_info",e).text(s.info))})}),P("body").on("click",".wpo_smush_unmark_single_image .button",function(){var s={attachment_id:P(this).data("id"),blog_id:P(this).data("blog")},e=P(this).closest("#smush-metabox-inside-wrapper");I(wposmush.please_updating_images_info),z("mark_as_compressed",{selected_images:[s],unmark:!0},function(s){P("#smush-information-modal .smush-information").text(s.summary),I(P("#smush-information-modal"),P.unblockUI),s.status&&(P(".wpo_smush_single_image",e).show(),P(".wpo_smush_mark_single_image",e).show(),P(".wpo_smush_unmark_single_image",e).hide(),P(".wpo_restore_single_image",e).hide(),P("#smush_info",e).text(""))})}),P("body").on("click","#wpo_smush_details .wpo-collapsible",o),P("body").on("click",".column-wpo_smush .wpo-collapsible",o),P("body").on("click","#smush-log-modal .close, #smush-information-modal .information-modal-close",function(){P.unblockUI()}),P("body").on("click",".wpo_smush_stats_cta_btn, .wpo_smush_get_logs, #smush-complete-summary .close",function(){P.unblockUI(),t(),setTimeout(f,500)}),P("body").on("click",".wpo-toggle-advanced-options",function(s){s.preventDefault(),P(this).toggleClass("opened")}),P(".wpo-fieldgroup .autosmush input, .wpo-fieldgroup .compression_level, .wpo-fieldgroup .image_options, #smush-show-metabox, #enable_webp_conversion").on("change",function(s){n()}),P("body").on("change",".smush-options.compression_level",function(){P("#enable_custom_compression").is(":checked")?P(".smush-options.custom_compression").show():P(".smush-options.custom_compression").hide()}),P("body").on("change",'.smush-advanced input[type="radio"]',function(){b()}),D.on("click",function(s){s.preventDefault();var e=P(this);data={attachment_id:P(this).data("attachment-id")},I(wposmush.converting_to_webp),z("convert_to_webp_format",data,function(s){s.error?(I(s.error,P.unblockUI),setTimeout(function(){P.unblockUI()},2e3)):(I(s.success,P.unblockUI),setTimeout(function(){P.unblockUI()},2e3),e.next().remove(),e.remove())})}),uncompressed_images_sites_select.on("change",function(){t()}),P(document).on("admin-metabox-smush-loaded",function(){var s=P('.wpo_restore_single_image input[type="button"]').first().data();if(s&&smush_affected_images.hasOwnProperty(s.blog)&&smush_affected_images[s.blog].hasOwnProperty(s.id)){var e=smush_affected_images[s.blog][s.id];"compress"==e.operation?O(e.operation,e.summary,e.restore_possible,e):O(e.operation)}});var F=function(){var s="";s=P("#enable_custom_compression").is(":checked")?P("#custom_compression_slider").val():P("#enable_lossy_compression").is(":checked")?60:100;var e=s<100;return{compression_server:P("input[name='compression_server']:checked").val(),image_quality:s,lossy_compression:e,back_up_original:P("#smush-backup-original").is(":checked"),back_up_delete_after:P("#smush-backup-delete").is(":checked"),back_up_delete_after_days:P("#smush-backup-delete-days").val(),preserve_exif:P("#smush-preserve-exif").is(":checked"),autosmush:P("#smush-automatically").is(":checked"),show_smush_metabox:P("#smush-show-metabox").is(":checked"),webp_conversion:P("#enable_webp_conversion").is(":checked")}};wp_optimize.smush_settings=F};