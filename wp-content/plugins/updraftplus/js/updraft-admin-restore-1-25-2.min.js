var updraft_restore_screen=!0;jQuery(function(p){var n,d,u,l=p("#updraftplus_ajax_restore_job_id").val(),e=p("#updraftplus_ajax_restore_action").val(),i=0,c=p("#updraftplus_ajax_restore_output"),_=p(".updraft_restore_components_list"),r=!1,f=0,g=0;function h(e,t){var r=new XMLHttpRequest,e="action="+t+"&updraftplus_ajax_restore=do_ajax_restore&job_id="+e,o=("updraft_ajaxrestore"===t&&(e+="&nonce="+updraft_credentialtest_nonce),0),n=!0,d=p("#updraftplus_ajax_restore_debug").length;r.open("POST",ajaxurl,!0),r.onprogress=function(e){if(200<=e.currentTarget.status&&e.currentTarget.status<300){if(-1!==e.currentTarget.responseText.indexOf("<html"))n&&(n=!1,alert("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_invalid_response)),c.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_invalid_response),console.log("UpdraftPlus restore error: HTML detected in response could be a copy of the WordPress front page caused by mod_security"),console.log(e.currentTarget.responseText);else if(o!=e.currentTarget.responseText.length){i=Math.round(Date.now()/1e3);for(var t,r=e.currentTarget.responseText.substr(o),a=(o=e.currentTarget.responseText.length,0),s=0;a<r.length;)"RINFO:{"==r.substr(a,7)?(c.append(r.substring(s,a).trim()).scrollTop(c[0].scrollHeight),t=ud_parse_json(r.substr(a),!0),1==d&&console.log(t),m(t.parsed),a=s=a+t.json_last_pos-t.json_start_pos+6):a++;c.append(r.substr(s).trim()).scrollTop(c[0].scrollHeight),c.find("input[name=connection_type]").length&&c.find("#upgrade").length&&(p(".updraft_restore_main").addClass("show-credentials-form"),p("#message").length)&&(p(".restore-credential-errors .restore-credential-errors--list").appendTo(p("#message")),p(".restore-credential-errors .restore-credential-errors--link").appendTo(p("#message")))}}else 0==e.currentTarget.status?c.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_contact_failed):c.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+e.currentTarget.status+" "+e.currentTarget.statusText),console.log("UpdraftPlus restore error: "+e.currentTarget.status+" "+e.currentTarget.statusText),console.log(e.currentTarget)},r.onload=function(){var e,t=c.find(".updraft_restore_successful, .updraft_restore_error");t.length&&((e=p(".updraft_restore_result")).slideDown(),_.slideUp(),_.siblings("h2").slideUp(),t.is(".updraft_restore_successful")?(e.find(".dashicons").addClass("dashicons-yes"),e.find(".updraft_restore_result--text").text(t.text()),e.addClass("restore-success")):t.is(".updraft_restore_error")&&(e.find(".dashicons").addClass("dashicons-no-alt"),e.find(".updraft_restore_result--text").text(t.text()),e.addClass("restore-error")),setTimeout(function(){c.scrollTop(c[0].scrollHeight)},500))},r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(e)}function m(e){var t,r,a,s,o;"started"==e.stage&&(n=setInterval(function(){var e;(e=Math.round(Date.now()/1e3)-i)<60?p("#updraftplus_ajax_restore_last_activity").html(updraftlion.last_activity.replace("%d",e)):0<(e=120-e)?p("#updraftplus_ajax_restore_last_activity").html(updraftlion.no_recent_activity.replace("%d",e)):(p("#updraftplus_ajax_restore_last_activity").html(""),updraft_send_command("get_restore_resume_notice",{job_id:l},function(e){e.hasOwnProperty("status")&&"success"==e.status&&e.hasOwnProperty("html")?(n&&clearInterval(n),"plugins"!=u&&"db"!=u&&f<5?(f++,h(l,"updraft_ajaxrestore_continue")):p(".updraft_restore_main--components").prepend(e.html)):e.hasOwnProperty("error_code")&&e.hasOwnProperty("error_message")&&(n&&clearInterval(n),alert(e.error_code+": "+e.error_message),console.log(e.error_code+": "+e.error_message))},{error_callback:function(e,t,r,a){500==e.status&&g<3?(g++,h(l,"updraft_ajaxrestore_continue")):(m({stage:"finished",type:"state_change"}),t="updraft_send_command: error: "+t+" ("+r+")",alert(t),console.log(t),console.log(e))}}))},5e3)),"finished"==e.stage&&n&&(clearInterval(n),p("#updraftplus_ajax_restore_last_activity").html("")),!e||"state"!=e.type&&"state_change"!=e.type||(console.log(e.stage,e.data),u="files"==e.stage?e.data.entity:e.stage,t=_.find("[data-component="+u+"]"),"files"==e.stage&&t.find(".updraft_component--progress").html(" — "+updraftlion.restore_files_progress.replace("%s1","<strong>"+e.data.fileindex+"</strong>").replace("%s2","<strong>"+e.data.total_files+"</strong>")),"db"==e.stage&&e.data.hasOwnProperty("stage")&&("table"==e.data.stage?t.find(".updraft_component--progress").html(" — "+updraftlion.restore_db_table_progress.replace("%s","<strong>"+e.data.table+"</strong>")):"stored_routine"==e.data.stage?t.find(".updraft_component--progress").html(" — "+updraftlion.restore_db_stored_routine_progress.replace("%s","<strong>"+e.data.routine_name+"</strong>")):"finished"==e.data.stage?t.find(".updraft_component--progress").html(" — "+updraftlion.finished):"begun"==e.data.stage&&t.find(".updraft_component--progress").html(" — "+updraftlion.begun+"...")),d!==u&&(d&&((r=_.find("[data-component="+d+"]")).find(".updraft_component--progress").html(""),r.removeClass("active").addClass("done")),"finished"==u?(t.addClass("done"),_.find("[data-component]").each(function(e,t){($el=p(t)).is(".done")||$el.addClass("error")}),e.data.hasOwnProperty("actions")&&"object"==typeof e.data.actions&&(r=e.data.urls,a=function(e){p.isEmptyObject(e)||(p(".updraft_restore_result").before(updraftlion.ajax_restore_404_detected),p.each(e,function(e,t){p(".updraft_missing_pages").append("<li>"+t+"</li>")}))},s=[],o=[],p.each(r,function(e,t){var r=p.Deferred(),a=(o.push(r.promise()),new XMLHttpRequest);a.onreadystatechange=function(){4==this.readyState&&(404==this.status&&s.push(t),r.resolve())},a.open("GET",t,!0),a.send(null)}),p.when.apply(p,o).done(function(){a(s)}),p.each(e.data.actions,function(e,t){_.after('<a href="'+t+'" class="button button-primary">'+e+"</a>")}))):t.addClass("active")),d=u)}p("#updraft-restore-hidethis").remove(),h(l,e),p("#updraftplus_ajax_restore_progress").on("click","#updraft_restore_resume",function(e){e.preventDefault(),p("#updraftplus_ajax_restore_progress").slideUp(1e3,function(){p(this).remove()}),h(l,"updraft_ajaxrestore_continue")}),p(document).on("heartbeat-tick",function(e,t){t.hasOwnProperty("wp-auth-check")&&(t["wp-auth-check"]?(r&&t["wp-auth-check"]&&(i=Math.round(Date.now()/1e3),r=!1),t.hasOwnProperty("updraftplus")&&(t=t.updraftplus).hasOwnProperty("updraft_credentialtest_nonce")&&(updraft_credentialtest_nonce=t.updraft_credentialtest_nonce,i=Math.round(Date.now()/1e3))):r=!0)})});